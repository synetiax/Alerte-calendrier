<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Alerte Calendrier</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#4A90A4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh; color: #fff; padding: 20px; padding-bottom: 100px;
        }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 1.8em; margin-bottom: 5px; color: #4A90A4; }
        .header .subtitle { color: #888; font-size: 0.9em; }
        .status-card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .status-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .status-row:last-child { border-bottom: none; }
        .status-label { color: #aaa; }
        .status-value { font-weight: bold; }
        .status-value.active { color: #4ade80; }
        .status-value.inactive { color: #f87171; }
        .status-value.warning { color: #fbbf24; }
        .btn { display: block; width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: transform 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #4A90A4 0%, #357a8c 100%); color: white; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .section-title { font-size: 1.2em; margin: 25px 0 15px; color: #4A90A4; }
        .event-list { background: rgba(255,255,255,0.05); border-radius: 15px; overflow: hidden; }
        .event-item { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .event-item:last-child { border-bottom: none; }
        .event-title { font-weight: bold; margin-bottom: 5px; }
        .event-time { color: #4A90A4; font-size: 0.9em; }
        .event-calendar { color: #888; font-size: 0.8em; margin-top: 3px; }
        .event-alert { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; margin-left: 10px; }
        .event-alert.alert1 { background: #60a5fa; color: #000; }
        .event-alert.alert2 { background: #f87171; color: #000; }
        .no-events { text-align: center; padding: 30px; color: #888; }
        .settings-section { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 15px; margin-bottom: 20px; }
        .alert-config { background: rgba(255,255,255,0.08); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .alert-config-title { font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .alert-config-title .badge { padding: 3px 10px; border-radius: 15px; font-size: 0.8em; }
        .alert-config-title .badge.alert1 { background: #60a5fa; color: #000; }
        .alert-config-title .badge.alert2 { background: #f87171; color: #000; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .setting-label { flex: 1; }
        .setting-label small { display: block; color: #888; font-size: 0.8em; }
        input[type="number"] { width: 80px; padding: 8px; border: none; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; text-align: center; font-size: 1em; }
        .toggle { position: relative; width: 50px; height: 28px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.2); transition: 0.3s; border-radius: 28px; }
        .toggle-slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; }
        .toggle input:checked + .toggle-slider { background-color: #4ade80; }
        .toggle input:checked + .toggle-slider:before { transform: translateX(22px); }
        .log-section { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.8em; }
        .log-entry { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-entry.error { color: #f87171; }
        .log-entry.success { color: #4ade80; }
        .log-entry.info { color: #60a5fa; }
        .log-entry.alert1 { color: #60a5fa; }
        .log-entry.alert2 { color: #f87171; }
        .hidden { display: none !important; }
        .refresh-indicator { position: fixed; top: 10px; right: 10px; background: rgba(74, 144, 164, 0.9); padding: 8px 15px; border-radius: 20px; font-size: 0.8em; opacity: 0; transition: opacity 0.3s; }
        .refresh-indicator.show { opacity: 1; }
        .next-alert { background: linear-gradient(135deg, #4A90A4 0%, #357a8c 100%); border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .next-alert-label { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .next-alert-title { font-size: 1.3em; font-weight: bold; margin-bottom: 5px; }
        .next-alert-time { font-size: 0.95em; }
        .next-alert-countdown { font-size: 2em; font-weight: bold; margin-top: 10px; color: #fbbf24; }
        .test-buttons { display: flex; gap: 10px; }
        .test-buttons .btn { flex: 1; }
        .btn-alert1 { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); color: #000; }
        .btn-alert2 { background: linear-gradient(135deg, #f87171 0%, #ef4444 100%); color: #000; }
    </style>
</head>
<body>
    <div class="refresh-indicator" id="refreshIndicator">üîÑ Actualisation...</div>
    <div class="header">
        <h1>üîî Alerte Calendrier</h1>
        <p class="subtitle">2 alertes personnalisables avant vos √©v√©nements</p>
    </div>
    <div class="next-alert hidden" id="nextAlertCard">
        <div class="next-alert-label">‚è∞ Prochaine alerte</div>
        <div class="next-alert-title" id="nextAlertTitle">-</div>
        <div class="next-alert-time" id="nextAlertTime">-</div>
        <div class="next-alert-countdown" id="nextAlertCountdown">-</div>
    </div>
    <div class="status-card">
        <div class="status-row"><span class="status-label">Notifications</span><span class="status-value" id="notifStatus">-</span></div>
        <div class="status-row"><span class="status-label">Service Worker</span><span class="status-value" id="swStatus">-</span></div>
        <div class="status-row"><span class="status-label">Derni√®re v√©rification</span><span class="status-value" id="lastCheck">-</span></div>
        <div class="status-row"><span class="status-label">√âv√©nements surveill√©s</span><span class="status-value" id="eventCount">0</span></div>
    </div>
    <button class="btn btn-primary" id="btnActivate" onclick="requestNotificationPermission()">üîî Activer les notifications</button>
    <button class="btn btn-secondary" onclick="refreshEvents()">üîÑ Actualiser les √©v√©nements</button>
    <div class="test-buttons">
        <button class="btn btn-alert1" onclick="testAlert(1)">üîä Test Alerte 1</button>
        <button class="btn btn-alert2" onclick="testAlert(2)">üîä Test Alerte 2</button>
    </div>
    <h2 class="section-title">‚öôÔ∏è Configuration des alertes</h2>
    <div class="alert-config">
        <div class="alert-config-title"><span class="badge alert1">Alerte 1</span> Rappel anticip√© (son doux)</div>
        <div class="setting-row"><div class="setting-label">Minutes avant l'√©v√©nement</div><input type="number" id="alert1Minutes" value="90" min="1" max="240" onchange="saveSettings()"></div>
        <div class="setting-row"><div class="setting-label">Activ√©e</div><label class="toggle"><input type="checkbox" id="alert1Enabled" checked onchange="saveSettings()"><span class="toggle-slider"></span></label></div>
    </div>
    <div class="alert-config">
        <div class="alert-config-title"><span class="badge alert2">Alerte 2</span> Rappel urgent (son fort)</div>
        <div class="setting-row"><div class="setting-label">Minutes avant l'√©v√©nement</div><input type="number" id="alert2Minutes" value="5" min="1" max="60" onchange="saveSettings()"></div>
        <div class="setting-row"><div class="setting-label">Activ√©e</div><label class="toggle"><input type="checkbox" id="alert2Enabled" checked onchange="saveSettings()"><span class="toggle-slider"></span></label></div>
    </div>
    <div class="settings-section">
        <div class="setting-row"><div class="setting-label">Intervalle de v√©rification (min)<small>Fr√©quence de mise √† jour</small></div><input type="number" id="checkInterval" value="5" min="1" max="60" onchange="saveSettings()"></div>
    </div>
    <h2 class="section-title">üìÖ √âv√©nements √† venir (24h)</h2>
    <div class="event-list" id="eventList"><div class="no-events">Chargement...</div></div>
    <h2 class="section-title">üìã Journal</h2>
    <div class="log-section" id="logSection"></div>
    <button class="btn btn-secondary" style="margin-top: 15px;" onclick="clearLog()">üóëÔ∏è Effacer le journal</button>

    <script>
        const API_KEY = 'AIzaSyBveWGrBZeRpbksaFoOAcTZILLjyAs7mW0';
        const CALENDAR_IDS = ['synetiax@gmail.com', 'family09469303655378432177@group.calendar.google.com', 'parent.maeva.leanne@gmail.com'];
        let events = [], scheduledAlerts = new Map(), checkIntervalId = null, countdownIntervalId = null;

        function playAlertSound(alertNum) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (alertNum === 1) {
                    [523, 659, 784, 1047].forEach((freq, i) => {
                        setTimeout(() => {
                            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
                            osc.connect(gain); gain.connect(audioCtx.destination);
                            osc.frequency.value = freq; osc.type = 'sine';
                            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                            osc.start(audioCtx.currentTime); osc.stop(audioCtx.currentTime + 0.5);
                        }, i * 200);
                    });
                } else {
                    for (let i = 0; i < 6; i++) {
                        setTimeout(() => {
                            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
                            osc.connect(gain); gain.connect(audioCtx.destination);
                            osc.frequency.value = i % 2 === 0 ? 880 : 1100; osc.type = 'square';
                            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
                            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                            osc.start(audioCtx.currentTime); osc.stop(audioCtx.currentTime + 0.15);
                        }, i * 180);
                    }
                }
            } catch (e) { log('Erreur son: ' + e.message, 'error'); }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            log('Application d√©marr√©e', 'info'); loadSettings(); updateStatus();
            if ('serviceWorker' in navigator) {
                try { await navigator.serviceWorker.register('sw.js'); log('Service Worker OK', 'success'); document.getElementById('swStatus').textContent = 'Actif'; document.getElementById('swStatus').className = 'status-value active'; }
                catch (e) { log('Erreur SW: ' + e.message, 'error'); document.getElementById('swStatus').textContent = 'Erreur'; document.getElementById('swStatus').className = 'status-value inactive'; }
            } else { document.getElementById('swStatus').textContent = 'Non support√©'; document.getElementById('swStatus').className = 'status-value warning'; }
            updateNotificationStatus(); await refreshEvents(); startPeriodicCheck(); startCountdown();
        });

        function log(msg, type = '') {
            const ls = document.getElementById('logSection'), time = new Date().toLocaleTimeString('fr-CA');
            const e = document.createElement('div'); e.className = 'log-entry ' + type; e.textContent = `[${time}] ${msg}`;
            ls.insertBefore(e, ls.firstChild); while (ls.children.length > 50) ls.removeChild(ls.lastChild); saveLog();
        }
        function clearLog() { document.getElementById('logSection').innerHTML = ''; localStorage.removeItem('alertCalendarLog'); log('Journal effac√©', 'info'); }
        function saveLog() { localStorage.setItem('alertCalendarLog', document.getElementById('logSection').innerHTML); }
        function loadLog() { const s = localStorage.getItem('alertCalendarLog'); if (s) document.getElementById('logSection').innerHTML = s; }
        function saveSettings() {
            localStorage.setItem('alertCalendarSettings', JSON.stringify({
                alert1Minutes: parseInt(document.getElementById('alert1Minutes').value),
                alert1Enabled: document.getElementById('alert1Enabled').checked,
                alert2Minutes: parseInt(document.getElementById('alert2Minutes').value),
                alert2Enabled: document.getElementById('alert2Enabled').checked,
                checkInterval: parseInt(document.getElementById('checkInterval').value)
            }));
            log('Param√®tres sauvegard√©s', 'success'); startPeriodicCheck(); scheduleAlerts();
        }
        function loadSettings() {
            const s = localStorage.getItem('alertCalendarSettings');
            if (s) { const p = JSON.parse(s);
                document.getElementById('alert1Minutes').value = p.alert1Minutes || 90;
                document.getElementById('alert1Enabled').checked = p.alert1Enabled !== false;
                document.getElementById('alert2Minutes').value = p.alert2Minutes || 5;
                document.getElementById('alert2Enabled').checked = p.alert2Enabled !== false;
                document.getElementById('checkInterval').value = p.checkInterval || 5;
            } loadLog();
        }
        function getSettings() {
            return {
                alert1Minutes: parseInt(document.getElementById('alert1Minutes').value) || 90,
                alert1Enabled: document.getElementById('alert1Enabled').checked,
                alert2Minutes: parseInt(document.getElementById('alert2Minutes').value) || 5,
                alert2Enabled: document.getElementById('alert2Enabled').checked,
                checkInterval: parseInt(document.getElementById('checkInterval').value) || 5
            };
        }
        async function requestNotificationPermission() {
            if (!('Notification' in window)) { log('Notifications non support√©es', 'error'); return; }
            try { const p = await Notification.requestPermission(); log('Permission: ' + p, p === 'granted' ? 'success' : 'error'); updateNotificationStatus(); }
            catch (e) { log('Erreur: ' + e.message, 'error'); }
        }
        function updateNotificationStatus() {
            const st = document.getElementById('notifStatus'), btn = document.getElementById('btnActivate');
            if (!('Notification' in window)) { st.textContent = 'Non support√©'; st.className = 'status-value inactive'; btn.classList.add('hidden'); }
            else if (Notification.permission === 'granted') { st.textContent = 'Activ√©es ‚úì'; st.className = 'status-value active'; btn.classList.add('hidden'); }
            else if (Notification.permission === 'denied') { st.textContent = 'Refus√©es'; st.className = 'status-value inactive'; btn.textContent = '‚ö†Ô∏è Bloqu√©es'; btn.disabled = true; }
            else { st.textContent = 'En attente'; st.className = 'status-value warning'; }
        }
        function updateStatus() { document.getElementById('lastCheck').textContent = new Date().toLocaleTimeString('fr-CA'); }
        async function refreshEvents() {
            document.getElementById('refreshIndicator').classList.add('show');
            log('R√©cup√©ration...', 'info'); events = [];
            const now = new Date(), tomorrow = new Date(now.getTime() + 24*60*60*1000);
            for (const cid of CALENDAR_IDS) {
                try {
                    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(cid)}/events?key=${API_KEY}&timeMin=${now.toISOString()}&timeMax=${tomorrow.toISOString()}&singleEvents=true&orderBy=startTime`;
                    const r = await fetch(url);
                    if (!r.ok) throw new Error((await r.json()).error?.message || r.statusText);
                    const d = await r.json();
                    if (d.items?.length) {
                        events = events.concat(d.items.map(e => ({
                            id: e.id, title: e.summary || 'Sans titre',
                            start: new Date(e.start.dateTime || e.start.date),
                            calendar: cid.includes('family') ? 'FamilyWall' : cid.includes('parent.maeva') ? 'parent.maeva' : 'synetiax',
                            allDay: !e.start.dateTime
                        })));
                        log(`${d.items.length} √©v√©nement(s) - ${cid.split('@')[0]}`, 'success');
                    }
                } catch (e) { log(`Erreur ${cid.split('@')[0]}: ${e.message}`, 'error'); }
            }
            events.sort((a, b) => a.start - b.start);
            displayEvents(); scheduleAlerts(); updateStatus();
            document.getElementById('eventCount').textContent = events.length;
            document.getElementById('refreshIndicator').classList.remove('show');
            log(`Total: ${events.length} √©v√©nement(s)`, 'info');
        }
        function displayEvents() {
            const c = document.getElementById('eventList'), s = getSettings();
            if (!events.length) { c.innerHTML = '<div class="no-events">Aucun √©v√©nement (24h)</div>'; document.getElementById('nextAlertCard').classList.add('hidden'); return; }
            const now = new Date();
            c.innerHTML = events.map(e => {
                const a1 = new Date(e.start.getTime() - s.alert1Minutes*60*1000), a2 = new Date(e.start.getTime() - s.alert2Minutes*60*1000);
                const soon1 = s.alert1Enabled && a1 > now && a1 < new Date(now.getTime() + 2*60*60*1000);
                const soon2 = s.alert2Enabled && a2 > now && a2 < new Date(now.getTime() + 30*60*1000);
                return `<div class="event-item"><div class="event-title">${e.title}${soon1 ? `<span class="event-alert alert1">${s.alert1Minutes}min</span>` : ''}${soon2 ? `<span class="event-alert alert2">${s.alert2Minutes}min</span>` : ''}</div><div class="event-time">${e.allDay ? 'Journ√©e' : formatTime(e.start)}</div><div class="event-calendar">üìÖ ${e.calendar}</div></div>`;
            }).join('');
        }
        function formatTime(d) { return d.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' }); }
        function scheduleAlerts() {
            scheduledAlerts.forEach(t => clearTimeout(t)); scheduledAlerts.clear();
            const s = getSettings(), now = new Date();
            events.forEach(e => {
                if (e.allDay) return;
                if (s.alert1Enabled) {
                    const t = new Date(e.start.getTime() - s.alert1Minutes*60*1000), ms = t - now;
                    if (ms > 0 && ms < 24*60*60*1000) { scheduledAlerts.set(`${e.id}-1`, setTimeout(() => triggerAlert(e, 1, s.alert1Minutes), ms)); log(`Alerte 1: "${e.title}" √† ${formatTime(t)}`, 'alert1'); }
                }
                if (s.alert2Enabled) {
                    const t = new Date(e.start.getTime() - s.alert2Minutes*60*1000), ms = t - now;
                    if (ms > 0 && ms < 24*60*60*1000) { scheduledAlerts.set(`${e.id}-2`, setTimeout(() => triggerAlert(e, 2, s.alert2Minutes), ms)); log(`Alerte 2: "${e.title}" √† ${formatTime(t)}`, 'alert2'); }
                }
            });
            updateNextAlertDisplay();
        }
        function updateNextAlertDisplay() {
            const s = getSettings(), now = new Date(); let next = null;
            events.forEach(e => {
                if (e.allDay) return;
                if (s.alert1Enabled) { const t = new Date(e.start.getTime() - s.alert1Minutes*60*1000); if (t > now && (!next || t < next.time)) next = { event: e, time: t, num: 1, min: s.alert1Minutes }; }
                if (s.alert2Enabled) { const t = new Date(e.start.getTime() - s.alert2Minutes*60*1000); if (t > now && (!next || t < next.time)) next = { event: e, time: t, num: 2, min: s.alert2Minutes }; }
            });
            const card = document.getElementById('nextAlertCard');
            if (next) { card.classList.remove('hidden'); document.getElementById('nextAlertTitle').textContent = next.event.title; document.getElementById('nextAlertTime').textContent = `√âv√©nement √† ${formatTime(next.event.start)} ‚Ä¢ Alerte ${next.num} √† ${formatTime(next.time)}`; }
            else card.classList.add('hidden');
        }
        function startCountdown() {
            if (countdownIntervalId) clearInterval(countdownIntervalId);
            countdownIntervalId = setInterval(() => {
                const s = getSettings(), now = new Date(); let next = null;
                events.forEach(e => {
                    if (e.allDay) return;
                    if (s.alert1Enabled) { const t = new Date(e.start.getTime() - s.alert1Minutes*60*1000); if (t > now && (!next || t < next)) next = t; }
                    if (s.alert2Enabled) { const t = new Date(e.start.getTime() - s.alert2Minutes*60*1000); if (t > now && (!next || t < next)) next = t; }
                });
                if (next) {
                    const diff = next - now;
                    if (diff > 0) {
                        const h = Math.floor(diff / 3600000), m = Math.floor((diff % 3600000) / 60000), sec = Math.floor((diff % 60000) / 1000);
                        document.getElementById('nextAlertCountdown').textContent = (h > 0 ? `${h}h ` : '') + `${m}m ${sec}s`;
                    }
                }
            }, 1000);
        }
        function triggerAlert(e, num, min) {
            const label = num === 1 ? 'Rappel' : '‚ö†Ô∏è URGENT';
            log(`üîî ${label}: "${e.title}" dans ${min} min!`, num === 1 ? 'alert1' : 'alert2');
            if (Notification.permission === 'granted') {
                const n = new Notification(`${label} - Dans ${min} min`, { body: e.title, icon: 'icon-192.png', tag: `${e.id}-${num}`, requireInteraction: true, vibrate: num === 1 ? [200,100,200] : [300,100,300,100,300] });
                n.onclick = () => { window.focus(); n.close(); };
            }
            playAlertSound(num); updateNextAlertDisplay();
        }
        function testAlert(num) {
            log(`Test alerte ${num}...`, 'info');
            if (Notification.permission === 'granted') new Notification(`Test Alerte ${num}`, { body: num === 1 ? 'Son doux' : 'Son urgent', icon: 'icon-192.png', requireInteraction: true });
            else log('Activer les notifications d\'abord', 'error');
            playAlertSound(num);
        }
        function startPeriodicCheck() {
            if (checkIntervalId) clearInterval(checkIntervalId);
            const s = getSettings();
            checkIntervalId = setInterval(() => { log('V√©rification...', 'info'); refreshEvents(); }, s.checkInterval * 60 * 1000);
            log(`V√©rification toutes les ${s.checkInterval} min`, 'info');
        }
        document.addEventListener('visibilitychange', () => { if (!document.hidden) { log('App active', 'info'); refreshEvents(); } });
    </script>
</body>
</html>
