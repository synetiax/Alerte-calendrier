<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Alerte Calendrier</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#4A90A4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            color: #4A90A4;
        }
        
        .header .subtitle {
            color: #888;
            font-size: 0.9em;
        }
        
        .status-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .status-row:last-child {
            border-bottom: none;
        }
        
        .status-label {
            color: #aaa;
        }
        
        .status-value {
            font-weight: bold;
        }
        
        .status-value.active {
            color: #4ade80;
        }
        
        .status-value.inactive {
            color: #f87171;
        }
        
        .status-value.warning {
            color: #fbbf24;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4A90A4 0%, #357a8c 100%);
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .section-title {
            font-size: 1.2em;
            margin: 25px 0 15px;
            color: #4A90A4;
        }
        
        .event-list {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .event-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .event-item:last-child {
            border-bottom: none;
        }
        
        .event-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .event-time {
            color: #4A90A4;
            font-size: 0.9em;
        }
        
        .event-calendar {
            color: #888;
            font-size: 0.8em;
            margin-top: 3px;
        }
        
        .event-alert {
            display: inline-block;
            background: #fbbf24;
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-left: 10px;
        }
        
        .no-events {
            text-align: center;
            padding: 30px;
            color: #888;
        }
        
        .settings-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }
        
        .setting-label {
            flex: 1;
        }
        
        .setting-label small {
            display: block;
            color: #888;
            font-size: 0.8em;
        }
        
        input[type="number"] {
            width: 80px;
            padding: 8px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            text-align: center;
            font-size: 1em;
        }
        
        .toggle {
            position: relative;
            width: 50px;
            height: 28px;
        }
        
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.2);
            transition: 0.3s;
            border-radius: 28px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        .toggle input:checked + .toggle-slider {
            background-color: #4ade80;
        }
        
        .toggle input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        .log-section {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8em;
        }
        
        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .log-entry.error {
            color: #f87171;
        }
        
        .log-entry.success {
            color: #4ade80;
        }
        
        .log-entry.info {
            color: #60a5fa;
        }
        
        .hidden {
            display: none !important;
        }
        
        .refresh-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(74, 144, 164, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .refresh-indicator.show {
            opacity: 1;
        }
        
        .next-alert {
            background: linear-gradient(135deg, #4A90A4 0%, #357a8c 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .next-alert-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .next-alert-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .next-alert-time {
            font-size: 1.1em;
        }
        
        .next-alert-countdown {
            font-size: 2em;
            font-weight: bold;
            margin-top: 10px;
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <div class="refresh-indicator" id="refreshIndicator">üîÑ Actualisation...</div>
    
    <div class="header">
        <h1>üîî Alerte Calendrier</h1>
        <p class="subtitle">Notifications 30 min avant vos √©v√©nements</p>
    </div>
    
    <!-- Prochaine alerte -->
    <div class="next-alert hidden" id="nextAlertCard">
        <div class="next-alert-label">‚è∞ Prochaine alerte</div>
        <div class="next-alert-title" id="nextAlertTitle">-</div>
        <div class="next-alert-time" id="nextAlertTime">-</div>
        <div class="next-alert-countdown" id="nextAlertCountdown">-</div>
    </div>
    
    <!-- Statut -->
    <div class="status-card">
        <div class="status-row">
            <span class="status-label">Notifications</span>
            <span class="status-value" id="notifStatus">-</span>
        </div>
        <div class="status-row">
            <span class="status-label">Service Worker</span>
            <span class="status-value" id="swStatus">-</span>
        </div>
        <div class="status-row">
            <span class="status-label">Derni√®re v√©rification</span>
            <span class="status-value" id="lastCheck">-</span>
        </div>
        <div class="status-row">
            <span class="status-label">√âv√©nements surveill√©s</span>
            <span class="status-value" id="eventCount">0</span>
        </div>
    </div>
    
    <!-- Boutons d'action -->
    <button class="btn btn-primary" id="btnActivate" onclick="requestNotificationPermission()">
        üîî Activer les notifications
    </button>
    
    <button class="btn btn-secondary" onclick="refreshEvents()">
        üîÑ Actualiser les √©v√©nements
    </button>
    
    <button class="btn btn-secondary" onclick="testNotification()">
        üîä Tester l'alerte sonore
    </button>
    
    <!-- Param√®tres -->
    <h2 class="section-title">‚öôÔ∏è Param√®tres</h2>
    <div class="settings-section">
        <div class="setting-row">
            <div class="setting-label">
                Minutes avant l'√©v√©nement
                <small>D√©lai pour l'alerte</small>
            </div>
            <input type="number" id="alertMinutes" value="30" min="1" max="120" onchange="saveSettings()">
        </div>
        <div class="setting-row">
            <div class="setting-label">
                Intervalle de v√©rification (min)
                <small>Fr√©quence de mise √† jour</small>
            </div>
            <input type="number" id="checkInterval" value="5" min="1" max="60" onchange="saveSettings()">
        </div>
        <div class="setting-row">
            <div class="setting-label">
                Son d'alerte
                <small>Jouer un son avec la notification</small>
            </div>
            <label class="toggle">
                <input type="checkbox" id="soundEnabled" checked onchange="saveSettings()">
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>
    
    <!-- √âv√©nements √† venir -->
    <h2 class="section-title">üìÖ √âv√©nements √† venir (24h)</h2>
    <div class="event-list" id="eventList">
        <div class="no-events">Chargement...</div>
    </div>
    
    <!-- Journal -->
    <h2 class="section-title">üìã Journal</h2>
    <div class="log-section" id="logSection"></div>
    
    <button class="btn btn-secondary" style="margin-top: 15px;" onclick="clearLog()">
        üóëÔ∏è Effacer le journal
    </button>

    <script>
        // Configuration
        const API_KEY = 'AIzaSyBveWGrBZeRpbksaFoOAcTZILLjyAs7mW0';
        const CALENDAR_IDS = [
            'synetiax@gmail.com',
            'family09469303655378432177@group.calendar.google.com',
            'parent.maeva.leanne@gmail.com'
        ];
        
        // √âtat de l'application
        let events = [];
        let scheduledAlerts = new Map();
        let checkIntervalId = null;
        let countdownIntervalId = null;
        
        // Sons d'alerte (base64 int√©gr√© pour fonctionner hors ligne)
        const alertSoundUrl = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp+cnZmXmpueoKGfnZqXlZSVl5mbnp+fnpyamJaVlJSVlpibnZ+goJ+dnJqYlpWUlJWXmZudnp+fnp2bmZeWlZSUlZeZm52en5+enZuZl5aVlJSVl5mbnZ6fn56dm5mXlpWUlJWXmZudnp+fnp2bmZeWlZSUlZeZm52en5+enZuZl5aVlJSVl5mbnZ6fn56dm5mXlpWUlJWXmZudnp+fnp2bmZeWlZWVl5mbnZ6fn56dm5mXlpaVlZeZm52en5+enZuZl5aWlZWXmZudnp+fnp2bmZeWlpaVl5mbnZ6fn56dm5mXlpaWlZeZm52en5+enZuZl5aWlpWXmZudnp+fnp2bmZiWlpaWl5mbnZ6fn56dm5mYlpaWlpeZm52en5+enZuZmJaWlpaXmZudnp+fnp2bmZiWlpaWl5mbnZ6fn56dm5mYlpaWlpeZm52en5+fnp2bmZiWlpaXl5mbnZ6fn5+enZuZmJaWlpeXmZudnp+fn56dm5mYlpaWl5eZm52en5+fnp2bmZiWlpaXl5mbnZ6fn5+enZuZmJaWlpeXmZudnp+fn56dnJqYl5aWl5eZm52en5+fnp2cmpiXlpaXl5mbnZ6fn5+enZyamJeWlpeXmZudnp+fn56dnJqYl5aWl5eZm52en5+fnp2cmpiXlpaXl5mbnZ6fn5+enZyamJeWlpeZmZudnp+fn56dnJqYl5aXl5mZm52en5+fnp2cmpiXlpeXmZmbnZ6fn5+enZyamJeXl5eZmZudnp+fn56dnJqYl5eXl5mZm52en5+fnp2cmpiXl5eXmZmbnZ6fn5+enZyamJeXl5eZmZudnp+fn56dnJqYl5eXmZmZm52en5+fnp2cmpiXl5eZmZmbnZ6fn5+enZyamJeXl5mZmZudnp+fn56dnJqYl5eXmZmZm52en5+fnp6dnJqYl5eXmZmZm52en5+fnp6dnJqYl5eXmZmZm52en5+fnp6dnJqYl5eXmZmZm52en5+fnp6dnJqYl5eXmZmZm52eoJ+fnp6dnJqYl5eXmZmZm52eoJ+fnp6dnJqYl5eZmZmZm52eoJ+fnp6dnJqYl5eZmZmZm52eoJ+fnp6dnJqYl5eZmZmZm52eoJ+fnp6dnZqYl5eZmZmZm52eoJ+fnp6dnZqYl5eZmZmZm52eoJ+fnp6dnZqYl5eZmZmZm52eoJ+fnp6dnZqYmJeZmZmZm52eoJ+fnp6dnZqYmJeZmZmZm52eoJ+fnp6dnZqYmJeZmZmZm52eoJ+fnp6dnZqYmJeZmZmZm52eoJ+fnp6dnZqYmJeZmZmZm52eoJ+fnp6dnZqYmJeZmZmZm52eoJ+fnp6dnZqYmJeZmZmZm52eoJ+fnp6dnZqYmJeZmZmbnZ2eoJ+fnp6dnZqYmJeZmZmbnZ2eoJ+fn56dnZqYmJeZmZmbnZ2eoJ+fn56dnZqYmJeZmZmbnZ2eoJ+fn56dnZqYmJeZmZmbnZ2eoJ+fn56dnZqYmJeZmZmbnZ2eoJ+fn56dnZqYmJeZmZmbnZ2eoJ+fn56dnZqYmJeZmZmbnZ2eoJ+fn56dnZqYmJmZmZmbnZ2eoJ+fn56dnZqYmJmZmZmbnZ2eoJ+fn56dnZqYmJmZmZmbnZ2eoJ+fn56dnZqYmJmZmZmbnZ2eoJ+fn56dnZqYmJmZmZmbnZ2eoJ+fn56dnZqYmJmZmZmbnZ2eoJ+fn56dnZqYmJmZmZmbnZ2eoJ+fn56dnZqZmJmZmZmbnZ2eoJ+fn56dnZqZmJmZmZmbnZ2eoJ+fn56dnZqZmJmZmZmbnZ2eoZ+fn56dnZqZmJmZmZmbnZ2eoZ+fn56dnZqZmJmZmZmbnZ6eoZ+fn56dnZqZmJmZmZmbnZ6eoZ+fn56dnZqZmJmZmZmbnZ6eoZ+fn56dnZqZmJmZmZmbnZ6eoZ+fn56dnZqZmJmZmZubnZ6eoZ+fn56dnZqZmJmZmZubnZ6eoZ+fn56dnZqZmJmZmZubnZ6eoZ+fn56dnZqZmJmZmZubnZ6eoZ+fn56enZqZmJmZmZubnZ6eoZ+fn56enZqZmJmZmZubnZ6eoZ+fn56enZqZmJmZmZubnZ6eoZ+fn56enZqZmJmZmZubnZ6eoZ+fn56enZqZmJmZmZubnZ6eoZ+fn56enZqZmJmZmZubnZ6eoZ+fn56enZqZmJmZmZubnZ6eoZ+foJ6enZqZmJmZmZubnZ6eoZ+foJ6enZqZmJmZmZubnZ6eoZ+foJ6enZqZmJmZmZubnZ6eoZ+foJ6enZqZmJmZmZubnZ6eoZ+foJ6enZqZmJmZmZubnZ6eoZ+foJ6enZqZmJmZmZubnZ6eoZ+foJ6enZqZmZmZmZubnZ6eoZ+foJ6enZqZmZmZmZubnZ6eoZ+foJ6enZqZmZmZmZubnZ6eoZ+foJ6enZqZ';
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            log('Application d√©marr√©e', 'info');
            loadSettings();
            updateStatus();
            
            // Enregistrer le Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('sw.js');
                    log('Service Worker enregistr√©', 'success');
                    document.getElementById('swStatus').textContent = 'Actif';
                    document.getElementById('swStatus').className = 'status-value active';
                } catch (error) {
                    log('Erreur Service Worker: ' + error.message, 'error');
                    document.getElementById('swStatus').textContent = 'Erreur';
                    document.getElementById('swStatus').className = 'status-value inactive';
                }
            } else {
                document.getElementById('swStatus').textContent = 'Non support√©';
                document.getElementById('swStatus').className = 'status-value warning';
            }
            
            // V√©rifier les permissions de notification
            updateNotificationStatus();
            
            // Charger les √©v√©nements
            await refreshEvents();
            
            // D√©marrer la v√©rification p√©riodique
            startPeriodicCheck();
            
            // D√©marrer le compte √† rebours
            startCountdown();
        });
        
        function log(message, type = '') {
            const logSection = document.getElementById('logSection');
            const time = new Date().toLocaleTimeString('fr-CA');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = `[${time}] ${message}`;
            logSection.insertBefore(entry, logSection.firstChild);
            
            // Garder seulement les 50 derni√®res entr√©es
            while (logSection.children.length > 50) {
                logSection.removeChild(logSection.lastChild);
            }
            
            // Sauvegarder le journal
            saveLog();
        }
        
        function clearLog() {
            document.getElementById('logSection').innerHTML = '';
            localStorage.removeItem('alertCalendarLog');
            log('Journal effac√©', 'info');
        }
        
        function saveLog() {
            const logSection = document.getElementById('logSection');
            localStorage.setItem('alertCalendarLog', logSection.innerHTML);
        }
        
        function loadLog() {
            const saved = localStorage.getItem('alertCalendarLog');
            if (saved) {
                document.getElementById('logSection').innerHTML = saved;
            }
        }
        
        function saveSettings() {
            const settings = {
                alertMinutes: parseInt(document.getElementById('alertMinutes').value),
                checkInterval: parseInt(document.getElementById('checkInterval').value),
                soundEnabled: document.getElementById('soundEnabled').checked
            };
            localStorage.setItem('alertCalendarSettings', JSON.stringify(settings));
            log('Param√®tres sauvegard√©s', 'success');
            
            // Red√©marrer la v√©rification p√©riodique avec le nouvel intervalle
            startPeriodicCheck();
            
            // Reprogrammer les alertes avec le nouveau d√©lai
            scheduleAlerts();
        }
        
        function loadSettings() {
            const saved = localStorage.getItem('alertCalendarSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('alertMinutes').value = settings.alertMinutes || 30;
                document.getElementById('checkInterval').value = settings.checkInterval || 5;
                document.getElementById('soundEnabled').checked = settings.soundEnabled !== false;
            }
            loadLog();
        }
        
        function getSettings() {
            return {
                alertMinutes: parseInt(document.getElementById('alertMinutes').value) || 30,
                checkInterval: parseInt(document.getElementById('checkInterval').value) || 5,
                soundEnabled: document.getElementById('soundEnabled').checked
            };
        }
        
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                log('Notifications non support√©es par ce navigateur', 'error');
                return;
            }
            
            try {
                const permission = await Notification.requestPermission();
                log('Permission notifications: ' + permission, permission === 'granted' ? 'success' : 'error');
                updateNotificationStatus();
            } catch (error) {
                log('Erreur permission: ' + error.message, 'error');
            }
        }
        
        function updateNotificationStatus() {
            const status = document.getElementById('notifStatus');
            const btn = document.getElementById('btnActivate');
            
            if (!('Notification' in window)) {
                status.textContent = 'Non support√©';
                status.className = 'status-value inactive';
                btn.classList.add('hidden');
            } else if (Notification.permission === 'granted') {
                status.textContent = 'Activ√©es ‚úì';
                status.className = 'status-value active';
                btn.classList.add('hidden');
            } else if (Notification.permission === 'denied') {
                status.textContent = 'Refus√©es';
                status.className = 'status-value inactive';
                btn.textContent = '‚ö†Ô∏è Notifications bloqu√©es (modifier dans les param√®tres)';
                btn.disabled = true;
            } else {
                status.textContent = 'En attente';
                status.className = 'status-value warning';
            }
        }
        
        function updateStatus() {
            document.getElementById('lastCheck').textContent = new Date().toLocaleTimeString('fr-CA');
        }
        
        async function refreshEvents() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.add('show');
            
            log('R√©cup√©ration des √©v√©nements...', 'info');
            events = [];
            
            const now = new Date();
            const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            
            for (const calendarId of CALENDAR_IDS) {
                try {
                    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?` +
                        `key=${API_KEY}` +
                        `&timeMin=${now.toISOString()}` +
                        `&timeMax=${tomorrow.toISOString()}` +
                        `&singleEvents=true` +
                        `&orderBy=startTime`;
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || response.statusText);
                    }
                    
                    const data = await response.json();
                    
                    if (data.items && data.items.length > 0) {
                        const calendarEvents = data.items.map(event => ({
                            id: event.id,
                            title: event.summary || 'Sans titre',
                            start: new Date(event.start.dateTime || event.start.date),
                            end: event.end ? new Date(event.end.dateTime || event.end.date) : null,
                            calendar: calendarId.includes('family') ? 'FamilyWall' : 
                                     calendarId.includes('parent.maeva') ? 'parent.maeva.leanne' : 'synetiax',
                            allDay: !event.start.dateTime
                        }));
                        events = events.concat(calendarEvents);
                        log(`${calendarEvents.length} √©v√©nement(s) trouv√©(s) dans ${calendarId.split('@')[0]}`, 'success');
                    }
                } catch (error) {
                    log(`Erreur calendrier ${calendarId.split('@')[0]}: ${error.message}`, 'error');
                }
            }
            
            // Trier par date de d√©but
            events.sort((a, b) => a.start - b.start);
            
            // Mettre √† jour l'affichage
            displayEvents();
            scheduleAlerts();
            updateStatus();
            document.getElementById('eventCount').textContent = events.length;
            
            indicator.classList.remove('show');
            log(`Total: ${events.length} √©v√©nement(s) dans les prochaines 24h`, 'info');
        }
        
        function displayEvents() {
            const container = document.getElementById('eventList');
            const settings = getSettings();
            
            if (events.length === 0) {
                container.innerHTML = '<div class="no-events">Aucun √©v√©nement dans les prochaines 24h</div>';
                document.getElementById('nextAlertCard').classList.add('hidden');
                return;
            }
            
            const now = new Date();
            
            container.innerHTML = events.map(event => {
                const alertTime = new Date(event.start.getTime() - settings.alertMinutes * 60 * 1000);
                const isAlertSoon = alertTime > now && alertTime < new Date(now.getTime() + 60 * 60 * 1000);
                
                return `
                    <div class="event-item">
                        <div class="event-title">
                            ${event.title}
                            ${isAlertSoon ? '<span class="event-alert">Alerte bient√¥t</span>' : ''}
                        </div>
                        <div class="event-time">
                            ${event.allDay ? 'Toute la journ√©e' : formatTime(event.start)}
                        </div>
                        <div class="event-calendar">üìÖ ${event.calendar}</div>
                    </div>
                `;
            }).join('');
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
        }
        
        function formatDate(date) {
            return date.toLocaleDateString('fr-CA', { weekday: 'short', day: 'numeric', month: 'short' });
        }
        
        function scheduleAlerts() {
            // Annuler les alertes existantes
            scheduledAlerts.forEach(timeoutId => clearTimeout(timeoutId));
            scheduledAlerts.clear();
            
            const settings = getSettings();
            const now = new Date();
            
            events.forEach(event => {
                if (event.allDay) return; // Pas d'alerte pour les √©v√©nements toute la journ√©e
                
                const alertTime = new Date(event.start.getTime() - settings.alertMinutes * 60 * 1000);
                const msUntilAlert = alertTime - now;
                
                if (msUntilAlert > 0 && msUntilAlert < 24 * 60 * 60 * 1000) {
                    const timeoutId = setTimeout(() => {
                        triggerAlert(event);
                    }, msUntilAlert);
                    
                    scheduledAlerts.set(event.id, timeoutId);
                    log(`Alerte programm√©e: "${event.title}" √† ${formatTime(alertTime)}`, 'info');
                }
            });
            
            updateNextAlertDisplay();
        }
        
        function updateNextAlertDisplay() {
            const settings = getSettings();
            const now = new Date();
            
            // Trouver le prochain √©v√©nement avec alerte
            const nextEvent = events.find(event => {
                if (event.allDay) return false;
                const alertTime = new Date(event.start.getTime() - settings.alertMinutes * 60 * 1000);
                return alertTime > now;
            });
            
            const card = document.getElementById('nextAlertCard');
            
            if (nextEvent) {
                const alertTime = new Date(nextEvent.start.getTime() - settings.alertMinutes * 60 * 1000);
                
                card.classList.remove('hidden');
                document.getElementById('nextAlertTitle').textContent = nextEvent.title;
                document.getElementById('nextAlertTime').textContent = 
                    `√âv√©nement √† ${formatTime(nextEvent.start)} ‚Ä¢ Alerte √† ${formatTime(alertTime)}`;
            } else {
                card.classList.add('hidden');
            }
        }
        
        function startCountdown() {
            if (countdownIntervalId) clearInterval(countdownIntervalId);
            
            countdownIntervalId = setInterval(() => {
                const settings = getSettings();
                const now = new Date();
                
                const nextEvent = events.find(event => {
                    if (event.allDay) return false;
                    const alertTime = new Date(event.start.getTime() - settings.alertMinutes * 60 * 1000);
                    return alertTime > now;
                });
                
                if (nextEvent) {
                    const alertTime = new Date(nextEvent.start.getTime() - settings.alertMinutes * 60 * 1000);
                    const diff = alertTime - now;
                    
                    if (diff > 0) {
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        
                        let countdown = '';
                        if (hours > 0) countdown += `${hours}h `;
                        countdown += `${minutes}m ${seconds}s`;
                        
                        document.getElementById('nextAlertCountdown').textContent = countdown;
                    }
                }
            }, 1000);
        }
        
        function triggerAlert(event) {
            const settings = getSettings();
            
            log(`üîî ALERTE: "${event.title}" dans ${settings.alertMinutes} minutes!`, 'success');
            
            // Notification syst√®me
            if (Notification.permission === 'granted') {
                const notification = new Notification(`‚è∞ Dans ${settings.alertMinutes} min`, {
                    body: event.title,
                    icon: 'icon-192.png',
                    tag: event.id,
                    requireInteraction: true,
                    vibrate: [200, 100, 200]
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
            
            // Son d'alerte
            if (settings.soundEnabled) {
                playAlertSound();
            }
            
            // Mettre √† jour l'affichage
            updateNextAlertDisplay();
        }
        
        function playAlertSound() {
            try {
                const audio = new Audio(alertSoundUrl);
                audio.volume = 1.0;
                audio.play().catch(e => log('Erreur son: ' + e.message, 'error'));
            } catch (error) {
                log('Erreur lecture son: ' + error.message, 'error');
            }
        }
        
        function testNotification() {
            log('Test de notification...', 'info');
            
            const settings = getSettings();
            
            if (Notification.permission === 'granted') {
                new Notification('üîî Test d\'alerte', {
                    body: 'Ceci est un test de notification',
                    icon: 'icon-192.png',
                    requireInteraction: true,
                    vibrate: [200, 100, 200]
                });
            } else {
                log('Permission de notification requise', 'error');
            }
            
            if (settings.soundEnabled) {
                playAlertSound();
            }
        }
        
        function startPeriodicCheck() {
            if (checkIntervalId) clearInterval(checkIntervalId);
            
            const settings = getSettings();
            const intervalMs = settings.checkInterval * 60 * 1000;
            
            checkIntervalId = setInterval(() => {
                log('V√©rification p√©riodique...', 'info');
                refreshEvents();
            }, intervalMs);
            
            log(`V√©rification toutes les ${settings.checkInterval} minutes`, 'info');
        }
        
        // G√©rer la visibilit√© de la page
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                log('Application au premier plan', 'info');
                refreshEvents();
            }
        });
    </script>
</body>
</html>
